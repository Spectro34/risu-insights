---
# Run RISU diagnostics on managed nodes
# Executes RISU and fetches results to control node
#
# Usage:
#   ansible-playbook run-diagnostics.yml -i inventory/hosts
#   ansible-playbook run-diagnostics.yml -i inventory/hosts -e "plugin_filter=system"
#   ansible-playbook run-diagnostics.yml -i inventory/hosts --limit server1

- name: Run RISU diagnostics
  hosts: all
  become: yes
  gather_facts: yes
  
  vars:
    risu_output_dir: /tmp/risu-results
    plugin_filter: ""
    results_output_file: "{{ risu_output_dir }}/risu-{{ inventory_hostname }}-{{ ansible_date_time.epoch }}.json"
    ansible_ssh_use_tty: false
    ansible_ssh_pipelining: true
    ansible_become: yes
    ansible_become_method: sudo

  tasks:
    # Verify RISU installation
    - name: Verify RISU is installed
      command: which risu
      changed_when: false
      register: risu_check
      tags: [always, verify]
    
    # Create output directory
    - name: Create output directory
      file:
        path: "{{ risu_output_dir }}"
        state: directory
        mode: '0755'
      tags: [always]
    
    # Run diagnostics
    - name: Run RISU diagnostics
      risu:
        state: run
        filter: "{{ plugin_filter }}"
        output: "{{ results_output_file }}"
        timeout: 600
      register: risu_run
      tags: [diagnostics]
    
    # Verify and fetch results
    - name: Verify output file exists
      stat:
        path: "{{ results_output_file }}"
      register: results_file
      tags: [diagnostics]
    
    - name: Fail if no output
      fail:
        msg: "RISU did not generate output: {{ results_output_file }}"
      when: not results_file.stat.exists
      tags: [diagnostics]
    
    # Read results JSON (no file storage)
    - name: Read results JSON
      slurp:
        src: "{{ results_output_file }}"
      register: results_json
      tags: [summary]
      no_log: true
    
    # Parse results and store as fact for server to extract
    - name: Parse results
      set_fact:
        risu_data_json: "{{ results_json.content | b64decode }}"
      tags: [summary]
      no_log: true
    
    # Display minimal summary
    - name: Display summary
      debug:
        msg: "RISU_RESULTS_JSON_START:{{ risu_data_json }}:RISU_RESULTS_JSON_END"
      tags: [summary]

- name: Summary
  hosts: localhost
  connection: local
  gather_facts: no
  
  tasks:
    - name: Display completion
      debug:
        msg: "âœ“ Diagnostics complete. Results processed and returned."
      tags: [always]
